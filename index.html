<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orpheus - Personalized Music</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* Previous styles remain the same */
        .error-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #ff4444;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 2000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .recommendation-error {
            color: #aaa;
            font-style: italic;
            padding: 10px;
            text-align: center;
        }
    </style>
</head>
<body>

<!-- Previous HTML remains the same until the script section -->

<script>
    // API Keys (In production, these should be handled via backend)
    const YOUTUBE_API_KEY = "AIzaSyAB5ZP3jnLtjz3IPRRrCe66yElwAJh8TsY";
    const DEEPSEEK_API_KEY = "sk-8c7d73d4fb414b4a88227ebfab5f3eb2"; // Replace with your actual key
    const DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions";
    
    // App State
    const CACHE_NAME = 'orpheus-video-cache';
    const playlists = {
        "hindi-videos": "PL4uUU2x5ZgR1JOlcY9SZB94MW6fBE8ovU",
        "english-videos": "PLx0sYbCqOb8TBPRdmBHs5Iftvv9TPboYG",
        "punjabi-videos": "PLFFyMei_d85U5RQdXjRQ5F012qr4vSmSa"
    };

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        initializeCache().then(() => {
            displayPlaybackHistory();
            
            // Check if we have enough history for personalized recommendations
            const history = getPlaybackHistory();
            if (history.length > 2) {
                generatePersonalizedRecommendations();
            } else {
                // Show default categories
                Object.keys(playlists).forEach(containerId => {
                    fetchPlaylistVideos(playlists[containerId], containerId);
                });
            }
            
            updatePersonalizedGreeting();
        });
        
        // Search on Enter key
        document.getElementById("search-query").addEventListener("keyup", function(event) {
            if (event.key === "Enter") searchYouTube();
        });
        
        // Close player button
        document.getElementById("close-player").addEventListener("click", function() {
            document.getElementById("floating-player").style.display = "none";
            document.getElementById("floating-video").src = "";
        });
    });

    // =====================
    // Enhanced API Functions
    // =====================
    async function fetchData(url, options = {}) {
        if (!url) {
            showErrorToast("Invalid request URL");
            return null;
        }
        
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`Request failed with status ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error("Fetch error:", error);
            showErrorToast("Failed to load data. Please try again.");
            return null;
        }
    }

    async function getDeepSeekRecommendations(userProfile) {
        try {
            // First check if API key is properly configured
            if (!DEEPSEEK_API_KEY || DEEPSEEK_API_KEY === "your_deepseek_api_key_here") {
                throw new Error("DeepSeek API key not configured");
            }

            // Prepare the prompt
            const prompt = `
                Analyze this user's music video history and suggest 5 personalized YouTube music video recommendations.
                Focus on their preferred genres: ${userProfile.genres.join(", ")}.
                Consider these recently watched videos: ${userProfile.watchedVideos.slice(0, 5).join(", ")}.
                
                Respond with only a JSON array in this exact format:
                [{
                    "title": "Recommended video title",
                    "search_query": "optimized YouTube search terms",
                    "reason": "Brief explanation for this recommendation"
                }]
            `;

            const data = await fetchData(DEEPSEEK_API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${DEEPSEEK_API_KEY}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0.7,
                    max_tokens: 500
                })
            });

            if (!data) {
                // Fallback to mock data if API fails
                return getMockRecommendations(userProfile);
            }

            const recommendations = JSON.parse(data.choices[0].message.content);
            
            // Search YouTube for these recommendations
            const videoResults = await Promise.all(
                recommendations.map(rec => 
                    searchYouTubeForRecommendation(rec.search_query || rec.title)
                )
            );
            
            // Add the recommendation reasons to the results
            return {
                recommendations: videoResults
                    .filter(v => v)
                    .map((v, i) => ({ 
                        ...v, 
                        reason: recommendations[i]?.reason || "" 
                    })),
                source: "deepseek"
            };
            
        } catch (error) {
            console.error("DeepSeek API Error:", error);
            showErrorToast("Personalization service unavailable. Using default recommendations.");
            return getMockRecommendations(userProfile);
        }
    }

    function getMockRecommendations(userProfile) {
        const genres = extractGenresFromHistory(userProfile.watchedVideos);
        if (genres.length === 0) {
            genres.push('popular'); // Fallback genre
        }
        
        const mockRecommendations = genres.map(genre => ({
            title: `Top ${genre} Songs This Week`,
            search_query: `latest ${genre} songs`,
            reason: `Based on trending ${genre} music`,
            isMock: true
        }));
        
        return {
            recommendations: mockRecommendations,
            source: "mock"
        };
    }

    // =====================
    // Enhanced Recommendation Generation
    // =====================
    async function generatePersonalizedRecommendations() {
        const section = document.getElementById('personalized-recommendations');
        const loading = document.getElementById('ai-loading');
        const videoList = document.querySelector('#personalized-recommendations .video-list');
        
        section.style.display = 'block';
        loading.style.display = 'inline-block';
        videoList.innerHTML = '';
        
        try {
            const history = getPlaybackHistory();
            if (history.length < 3) {
                throw new Error("Not enough history for recommendations");
            }

            const userProfile = {
                watchedVideos: history.map(video => video.title),
                genres: extractGenresFromHistory(history),
                watchTimes: history.map(video => video.timestamp)
            };
            
            const { recommendations, source } = await getDeepSeekRecommendations(userProfile);
            
            if (recommendations && recommendations.length > 0) {
                // Hide default categories when showing recommendations
                document.getElementById('hindi-videos').style.display = 'none';
                document.getElementById('english-videos').style.display = 'none';
                document.getElementById('punjabi-videos').style.display = 'none';
                
                displayRecommendations(recommendations);
                
                if (source === "mock") {
                    videoList.insertAdjacentHTML('beforeend', 
                        '<p class="recommendation-error">Showing default recommendations</p>');
                }
            } else {
                throw new Error("No recommendations available");
            }
        } catch (error) {
            console.error("Recommendation error:", error);
            videoList.innerHTML = `
                <div class="recommendation-error">
                    <p>We couldn't load personalized recommendations right now.</p>
                    <p>${error.message}</p>
                </div>
            `;
            
            // Show default categories as fallback
            Object.keys(playlists).forEach(containerId => {
                document.getElementById(containerId).style.display = "block";
                fetchPlaylistVideos(playlists[containerId], containerId);
            });
        } finally {
            loading.style.display = 'none';
        }
    }

    // =====================
    // UI Helper Functions
    // =====================
    function showErrorToast(message, duration = 5000) {
        const existingToast = document.querySelector('.error-toast');
        if (existingToast) existingToast.remove();
        
        const toast = document.createElement('div');
        toast.className = 'error-toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideIn 0.3s reverse forwards';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // =====================
    // Modified YouTube Functions with Error Handling
    // =====================
    async function searchYouTubeForRecommendation(query) {
        if (!query) return null;
        
        try {
            const API_URL = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=1&key=${YOUTUBE_API_KEY}`;
            const data = await fetchData(API_URL);
            
            if (data?.items?.[0]) {
                const video = data.items[0];
                return {
                    id: video.id.videoId,
                    title: video.snippet.title,
                    thumbnail: video.snippet.thumbnails?.medium?.url || 
                             video.snippet.thumbnails?.default?.url ||
                             'https://i.ytimg.com/vi/default.jpg',
                    description: video.snippet.description
                };
            }
            return null;
        } catch (error) {
            console.error("YouTube search failed:", error);
            return null;
        }
    }

    function fetchPlaylistVideos(playlistId, containerId) {
        const API_URL = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${playlistId}&maxResults=10&key=${YOUTUBE_API_KEY}`;
        
        fetchData(API_URL).then(data => {
            const videoList = document.querySelector(`#${containerId} .video-list`);
            if (!videoList) return;
            
            videoList.innerHTML = "";
            if (data?.items) {
                data.items.forEach(video => {
                    const videoId = video.snippet.resourceId.videoId;
                    const thumbnailUrl = video.snippet.thumbnails?.medium?.url || 
                                      video.snippet.thumbnails?.default?.url ||
                                      'https://i.ytimg.com/vi/default.jpg';
                    
                    createVideoElement(videoList, videoId, video.snippet.title, thumbnailUrl);
                });
            } else {
                videoList.innerHTML = '<p>Failed to load videos. Please try again later.</p>';
            }
        });
    }

    // Rest of your existing functions remain the same...
    // (displayRecommendations, extractGenresFromHistory, saveToPlaybackHistory, etc.)
</script>
</body>
</html>
